pipeline {
    agent any

    stages {
        stage('test-pipeline') {
            steps {
            	sh 'pwd'
                echo "test pipeline"
            }
        }
        stage('create Amazon ECR repository'){
			steps{
				echo "Inside creation repo"
				withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'AWS_Creds', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
					sh 'aws ecr describe-repositories --repository-names devops-nxt-repo || aws ecr create-repository --repository-name devops-nxt-repo'
					echo "Successfully created Amazon ECR"
				}
			}        
        }
        stage('Build docker image'){
        	steps{
        		echo "Building docker image"
        		sh 'docker --version'
        		sh 'mvn clean install'
        		script{
        			docker.build('devopsnxt-demo:latest', '-f Dockerfile .')
				}
        	}
        }
     }  
}
